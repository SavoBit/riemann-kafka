machine:
  services:
    - docker

  environment:
    version_file: VERSION

dependencies:
  pre:
    - git fetch --prune --tags
    - sudo apt-get update; sudo apt-get install g++ make build-essential
    - pip install virtualenv
    - pip install awscli
    - cd ~/bin ;curl https://raw.githubusercontent.com/technomancy/leiningen/stable/bin/lein
    - chmod a+x ~/bin/lein
    - lein
    
test:
  override:


deployment:
  assets:
    branch: master
    commands:
      # Get common ci scripts
      - git clone ssh://git@github.com/mistsys/mist-ci --depth 1 --quiet
      # Set up for pushing assets to github releases
      - go get github.com/aktau/github-release
      - git config --global user.email "circleci@mist.com"; git config --global user.name "CircleCI User"; git config --global push.default simple
      
      # Bump version
      - mist-ci/ci_tagging.sh $version_file
      - lein uberjar

      # Push to S3 releases
      
      - aws s3 cp target/riemann-kafka-0.1.2.jar s3://mist-dev-info/uberjars/
      - aws s3 cp target/riemann-kafka-0.1.2-standalone.jar s3://mist-dev-info/uberjars/
